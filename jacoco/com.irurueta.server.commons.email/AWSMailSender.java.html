<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AWSMailSender.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">com.irurueta:irurueta-server-commons-email</a> &gt; <a href="index.source.html" class="el_package">com.irurueta.server.commons.email</a> &gt; <span class="el_source">AWSMailSender.java</span></div><h1>AWSMailSender.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2016 Alberto Irurueta Carro (alberto@irurueta.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.irurueta.server.commons.email;

import com.amazonaws.auth.BasicAWSCredentials;
import com.amazonaws.services.simpleemail.AmazonSimpleEmailServiceClient;
import com.amazonaws.services.simpleemail.model.Destination;
import com.amazonaws.services.simpleemail.model.GetSendQuotaResult;
import com.amazonaws.services.simpleemail.model.Message;
import com.amazonaws.services.simpleemail.model.RawMessage;
import com.amazonaws.services.simpleemail.model.SendEmailRequest;
import com.amazonaws.services.simpleemail.model.SendEmailResult;
import com.amazonaws.services.simpleemail.model.SendRawEmailRequest;
import com.amazonaws.services.simpleemail.model.SendRawEmailResult;
import com.irurueta.server.commons.configuration.ConfigurationException;
import java.io.ByteArrayOutputStream;
import java.lang.ref.SoftReference;
import java.nio.ByteBuffer;
import java.util.Properties;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.mail.Session;
import javax.mail.internet.MimeMessage;

/**
 * Class to send emails using Amazon Web Services (AWS) SES.
 */
public class AWSMailSender extends 
        EmailSender&lt;Message&gt; {
    
    /**
     * Logger for this class.
     */
<span class="fc" id="L47">    public static final Logger LOGGER = Logger.getLogger(</span>
            AWSMailSender.class.getName());
    
    /**
     * Milliseconds to wait to check quota.
     */
    public static final long DEFAULT_CHECK_QUOTA_AFTER_MILLIS = 3600000;
    
    /**
     * Number of sent mails to take into account before checking quota.
     */
    public static final long MIN_CHECK_QUOTA_AFTER_MILLIS = 0;  
    
    /**
     * Number of milliseconds in a second.
     */
    private static final double MILLISECONDS_PER_SECOND = 1000.0;
    
    /**
     * Reference to singleton instance of this class.
     */
    private static SoftReference&lt;AWSMailSender&gt; mReference;
    
    /**
     * AWS SES credentials.
     */
    private AWSEmailSenderCredentials mCredentials;
    
    /**
     * Email address to be used as sender.
     */
    private String mMailFromAddress;
    
    /**
     * Indicates whether email sender is enabled or not.
     */
    private boolean mEnabled;
    
    /**
     * Internal client to be used for mail sending.
     */
    private AmazonSimpleEmailServiceClient mClient;
    
    /**
     * Indicates amount of milliseconds to check quota of mail sending returned 
     * by Amazon. This is used to prevent Amazon SES throttling.
     */
    private volatile long mCheckQuotaAfterMillis;
    
    /**
     * Timestamps of last sent email.
     */
    private volatile long mLastSentMailTimestamp;   
    
    /**
     * Amount of milliseconds to wait when next email must be sent if quota is
     * exceeded.
     */
    private volatile long mWaitIntervalMillis;
        
    /**
     * Constructor.
     * Loads mail configuration, and if it fails for some reason, mail sending
     * becomes disabled.
     */
<span class="fc" id="L112">    private AWSMailSender() {</span>
        
        try {
<span class="fc" id="L115">            MailConfiguration cfg = MailConfigurationFactory.getInstance().</span>
                    configure();
<span class="fc" id="L117">            mCredentials = cfg.getAWSMailCredentials();</span>
<span class="fc" id="L118">            mMailFromAddress = cfg.getMailFromAddress();</span>
        
<span class="pc bpc" id="L120" title="2 of 6 branches missed.">            mEnabled = mMailFromAddress != null &amp;&amp; </span>
                    isValidEmailAddress(mMailFromAddress) &amp;&amp; 
                    cfg.isMailSendingEnabled();
<span class="fc" id="L123">            mCheckQuotaAfterMillis = cfg.getAWSMailCheckQuotaAfterMillis();</span>
<span class="fc" id="L124">            mLastSentMailTimestamp = 0;</span>
<span class="fc" id="L125">            mWaitIntervalMillis = 0;  </span>
<span class="nc" id="L126">        } catch (ConfigurationException e) { </span>
<span class="nc" id="L127">            mEnabled = false;</span>
<span class="fc" id="L128">        }</span>
        
<span class="fc bfc" id="L130" title="All 2 branches covered.">        if (mEnabled) { </span>
<span class="fc" id="L131">            LOGGER.log(Level.INFO, &quot;AWS Email Sender enabled.&quot;);</span>
        } else {
<span class="fc" id="L133">            LOGGER.log(Level.INFO, &quot;AWS Email Sender disabled. Any &quot; +</span>
                    &quot;attempt to send emails using AWS SES will be &quot; +
                    &quot;silently ignored&quot;);            
        }
<span class="fc" id="L137">    }</span>
    
    /**
     * Returns or creates singleton instance of this class.
     * @return singleton of this class.
     */
    public static synchronized AWSMailSender getInstance() {
        AWSMailSender sender;
<span class="pc bpc" id="L145" title="1 of 4 branches missed.">        if (mReference == null || (sender = mReference.get()) == null) {</span>
<span class="fc" id="L146">            sender = new AWSMailSender();</span>
<span class="fc" id="L147">            mReference = new SoftReference&lt;&gt;(sender);</span>
        }
<span class="fc" id="L149">        return sender;</span>
    }   
    
    /**
     * Resets AWSMailSender singleton.
     */
    public static synchronized void reset() {
<span class="fc" id="L156">        mReference = null;</span>
<span class="fc" id="L157">    }</span>
    
    /**
     * Returns AWS SES credentials.
     * @return Amazon Web Services Simple Email Service credentials.
     */
    public AWSEmailSenderCredentials getCredentials() {
<span class="fc" id="L164">        return mCredentials;</span>
    }
    
    /**
     * Email address to send emails from.
     * @return email address to send emails from.
     */
    public String getMailFromAddress() {
<span class="fc" id="L172">        return mMailFromAddress;</span>
    }
    
    /**
     * Indicates if this mail sender controller is enabled.
     * @return true if enabled, false otherwise
     */
    public boolean isEnabled() {
<span class="fc" id="L180">        return mEnabled;</span>
    }    
    
    /**
     * Amount of milliseconds to wait before checking sending quota.
     * @return amount of milliseconds to wait before checking sending quota.
     */
    public long getCheckQuotaAfterMillis() {
<span class="fc" id="L188">        return mCheckQuotaAfterMillis;</span>
    }
    
    /**
     * Method to send an email.
     * @param m email message to be sent.
     * @return id of message that has been sent.
     * @throws MailNotSentException if mail couldn't be sent.
     */    
    @Override
    public String send(EmailMessage&lt;Message&gt; m) throws MailNotSentException {
        //to avoid compilation errors regaring to casting
<span class="fc" id="L200">        EmailMessage m2 = m; </span>
<span class="fc bfc" id="L201" title="All 2 branches covered.">        if (m2 instanceof AWSTextEmailMessage) {</span>
<span class="fc" id="L202">            return sendTextEmail((AWSTextEmailMessage)m2);</span>
<span class="fc bfc" id="L203" title="All 2 branches covered.">        } else if (m2 instanceof AWSTextEmailMessageWithAttachments) { </span>
<span class="fc" id="L204">            return sendRawEmail((AWSTextEmailMessageWithAttachments)m2);</span>
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">        } else if (m2 instanceof AWSHtmlEmailMessage) {</span>
<span class="fc" id="L206">            return sendRawEmail((AWSHtmlEmailMessage)m2);</span>
        } else {
<span class="nc" id="L208">            throw new MailNotSentException(&quot;Unsupported email type&quot;);</span>
        }
    }
    
    /**
     * Returns provider used by this email sender.
     * @return email provider.
     */
    @Override
    public EmailProvider getProvider() {
<span class="fc" id="L218">        return EmailProvider.AWS_MAIL;</span>
    }    
    
    /**
     * Method to send a text email.
     * @param m email message to be sent.
     * @return id of message that has been sent.
     * @throws MailNotSentException if mail couldn't be sent.
     */    
    private String sendTextEmail(AWSTextEmailMessage m) 
            throws MailNotSentException {
        String messageId;
<span class="fc" id="L230">        long currentTimestamp = System.currentTimeMillis();        </span>
<span class="fc" id="L231">        prepareClient();</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">        if (!mEnabled) {</span>
            //don't send message if not enabled
<span class="fc" id="L234">            return null;</span>
        } 
        
        try {
<span class="fc" id="L238">            synchronized (this) { </span>
                //prevents throttling
<span class="fc" id="L240">                checkQuota(currentTimestamp);</span>
                
<span class="fc" id="L242">                Destination destination = new Destination(m.getTo());</span>
<span class="pc bpc" id="L243" title="2 of 4 branches missed.">                if (m.getBCC() != null &amp;&amp; !m.getBCC().isEmpty()) {</span>
<span class="nc" id="L244">                    destination.setBccAddresses(m.getBCC());</span>
                }
<span class="pc bpc" id="L246" title="2 of 4 branches missed.">                if (m.getCC() != null &amp;&amp; !m.getCC().isEmpty()) {</span>
<span class="nc" id="L247">                    destination.setCcAddresses(m.getCC());</span>
                }
                
                //if no subject, set to empty string to avoid errors
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">                if (m.getSubject() == null) {</span>
<span class="nc" id="L252">                    m.setSubject(&quot;&quot;);</span>
                }
                
<span class="fc" id="L255">                Message message = new Message();</span>
<span class="fc" id="L256">                m.buildContent(message);</span>
                                
<span class="fc" id="L258">                SendEmailResult result = mClient.sendEmail(new SendEmailRequest(mMailFromAddress, destination, </span>
                        message));
<span class="fc" id="L260">                messageId = result.getMessageId();</span>
                //update timestamp of last sent email
<span class="fc" id="L262">                mLastSentMailTimestamp = System.currentTimeMillis();</span>
                
                //wait to avoid throwttling exceptions to avoid making any
                //further requests
<span class="fc" id="L266">                this.wait(mWaitIntervalMillis);</span>
<span class="pc" id="L267">            }</span>
<span class="nc" id="L268">        } catch (Throwable t) {</span>
<span class="nc" id="L269">            throw new MailNotSentException(t);</span>
<span class="fc" id="L270">        }      </span>
<span class="fc" id="L271">        return messageId;</span>
    }
    
    /**
     * Method to send a text email with attachments or HTML emails with 
     * attachments (inline or not).
     * @param m email message to be sent.
     * @return id of message that has been sent.
     * @throws MailNotSentException if mail couldn't be sent.
     */    
    private String sendRawEmail(EmailMessage&lt;MimeMessage&gt; m) 
            throws MailNotSentException {
        
        String messageId;
<span class="fc" id="L285">        long currentTimestamp = System.currentTimeMillis();        </span>
<span class="fc" id="L286">        prepareClient();</span>
<span class="pc bpc" id="L287" title="1 of 2 branches missed.">        if (!mEnabled) {</span>
            //don't send message if not enabled
<span class="nc" id="L289">            return null;</span>
        }
        
        try {
<span class="fc" id="L293">            synchronized (this) { </span>
                //prevents throttling and excessive memory usage
<span class="fc" id="L295">                checkQuota(currentTimestamp);</span>
                                                
                //if no subject, set to empty string to avoid errors
<span class="pc bpc" id="L298" title="1 of 2 branches missed.">                if (m.getSubject() == null) {</span>
<span class="nc" id="L299">                    m.setSubject(&quot;&quot;);</span>
                }
                                
<span class="fc" id="L302">                ByteArrayOutputStream outputStream = </span>
                        new ByteArrayOutputStream();

                //convert message into mime multi part and write it to output
                //stream into memory
<span class="fc" id="L307">                Session session = Session.getInstance(new Properties());</span>
<span class="fc" id="L308">                MimeMessage mimeMessage = new MimeMessage(session);</span>
<span class="pc bpc" id="L309" title="1 of 2 branches missed.">                if (m.getSubject() != null) {</span>
<span class="fc" id="L310">                    mimeMessage.setSubject(m.getSubject(), &quot;utf-8&quot;);</span>
                }
<span class="fc" id="L312">                m.buildContent(mimeMessage);</span>
<span class="fc" id="L313">                mimeMessage.writeTo(outputStream);</span>
                //m.buildMultipart().writeTo(outputStream);

<span class="fc" id="L316">                RawMessage rawMessage = new RawMessage(ByteBuffer.wrap(</span>
                        outputStream.toByteArray()));

<span class="fc" id="L319">                SendRawEmailRequest rawRequest = new SendRawEmailRequest(</span>
                        rawMessage);
<span class="fc" id="L321">                rawRequest.setDestinations(m.getTo());</span>
<span class="fc" id="L322">                rawRequest.setSource(mMailFromAddress);</span>
<span class="fc" id="L323">                SendRawEmailResult result = mClient.sendRawEmail(rawRequest);</span>
<span class="fc" id="L324">                messageId = result.getMessageId();</span>

                //update timestamp of last sent email
<span class="fc" id="L327">                mLastSentMailTimestamp = System.currentTimeMillis();</span>
                
                //wait to avoid throwttling exceptions to avoid making any
                //further requests
<span class="fc" id="L331">                this.wait(mWaitIntervalMillis);</span>
<span class="pc" id="L332">            }</span>
<span class="nc" id="L333">        } catch (Throwable t) {</span>
<span class="nc" id="L334">            throw new MailNotSentException(t);</span>
<span class="fc" id="L335">        }        </span>
        
<span class="fc" id="L337">        return messageId;</span>
    }   
            
    /**
     * Checks quota of sent emails to prevent AWS SES throttling.
     * @param currentTimestamp current timestamp.
     */
    private synchronized void checkQuota(long currentTimestamp) {
<span class="fc bfc" id="L345" title="All 2 branches covered.">        if ((currentTimestamp - mLastSentMailTimestamp) &gt; </span>
                mCheckQuotaAfterMillis) {
            //check quota to determine the number of messages per second to
            //avoid throttling exceptions
<span class="fc" id="L349">            GetSendQuotaResult quota = mClient.getSendQuota();</span>
            //updateinterval that we must wait between send requests
<span class="fc" id="L351">            mWaitIntervalMillis = (long)Math.ceil(</span>
                MILLISECONDS_PER_SECOND / quota.getMaxSendRate());
        }        
<span class="fc" id="L354">    }</span>
    
    /**
     * Prepares client by setting proper credentials.
     */
    private synchronized void prepareClient() {
<span class="fc bfc" id="L360" title="All 2 branches covered.">        if (mClient == null) {</span>
            //instantiate new client if needed
<span class="fc bfc" id="L362" title="All 2 branches covered.">            if (areValidCredentials()) {</span>
<span class="fc" id="L363">                mClient = new AmazonSimpleEmailServiceClient(</span>
                    new BasicAWSCredentials(mCredentials.getAccessKey(), 
                    mCredentials.getSecretKey()));
            } else {
                //disabling mail sending
<span class="fc" id="L368">                mEnabled = false;</span>
<span class="fc" id="L369">                Logger.getLogger(AWSMailSender.class.getName()).log(</span>
                    Level.INFO, &quot;AWS Email Sender disabled. &quot; + 
                        &quot;Invalid credentials&quot;);            
            }
        }        
<span class="fc" id="L374">    }</span>
    
    /**
     * Indicates whether provided credentials are valid.
     * @return true if credentials are valid, false otherwise.
     */
    private boolean areValidCredentials() {
<span class="pc bpc" id="L381" title="1 of 2 branches missed.">        if (mCredentials != null) {</span>
<span class="fc" id="L382">            return mCredentials.isReady();</span>
        } else {
<span class="nc" id="L384">            return false;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>